import { loggerInjectionToken } from "@kubesightapp/logger";
import { getInjectable, lifecycleEnum } from "@ogre-tools/injectable";
import broadcastMessageInjectable from "../../common/ipc/broadcast-message.injectable";

import type { Cluster } from "../../common/cluster/cluster";
import type { KubeAuthUpdate } from "../../common/cluster-types";

export type BroadcastConnectionUpdate = (update: KubeAuthUpdate) => void;

const broadcastConnectionUpdateInjectable = getInjectable({
  id: "broadcast-connection-update",
  instantiate: (di, cluster): BroadcastConnectionUpdate => {
    const broadcastMessage = di.inject(broadcastMessageInjectable);
    const logger = di.inject(loggerInjectionToken);

    return (update) => {
      logger.debug(`[CLUSTER]: broadcasting connection update`, { ...update, meta: cluster.getMeta() });
      broadcastMessage(`cluster:${cluster.id}:connection-update`, update);
    };
  },
  lifecycle: lifecycleEnum.keyedSingleton({
    getInstanceKey: (di, cluster: Cluster) => cluster.id,
  }),
});

export default broadcastConnectionUpdateInjectable;
